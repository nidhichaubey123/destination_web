@{
    Layout = "~/Pages/Shared/_Layout.cshtml";
}
@model DMCPortal.Web.Models.ViewModels.PaginatedSalesVisitViewModel


@{
    var loggedInUserId = User.Claims.FirstOrDefault(c => c.Type == "UserId")?.Value ?? "0";
    var loggedInUserName = User.Claims.FirstOrDefault(c => c.Type == "FullName")?.Value ?? "N/A";
    var userOperations = string.Join(",", User.Claims.Where(c => c.Type == "Operation").Select(c => c.Value));
}


 <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .header {
            background-color: #0066cc;
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .header h4 {
            margin: 0;
            font-weight: 600;
        }

        /* Mobile-first responsive header */
        .page-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .page-header h4 {
            margin: 0;
            font-size: 1.5rem;
        }

        .page-header .btn {
            width: 100%;
            padding: 12px;
            font-weight: 600;
        }

        /* Search form responsive */
        .search-container {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .search-form {
            display: flex;
            gap: 0.5rem;
            width: 100%;
        }

        .search-form input {
            flex: 1;
            min-width: 0;
        }

        .search-form button {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
        }

        /* Stats tiles responsive */
        .stats-row {
            margin-bottom: 2rem;
        }

        .tile-box {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            height: 100%;
            margin-bottom: 1rem;
        }

        .tile-box:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .tile-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .tile-content {
            flex: 1;
            min-width: 0;
        }

        .tile-title {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .tile-number {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        /* Table responsive */
        .table-container {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            margin-bottom: 0;
            min-width: 800px;
        }

        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
            white-space: nowrap;
            padding: 0.75rem 0.5rem;
        }

        .table td {
            padding: 0.75rem 0.5rem;
            vertical-align: middle;
            white-space: nowrap;
        }

        /* Action buttons responsive */
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        /* Pagination responsive */
        .pagination-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 1rem;
        }

        .pagination-container .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Modal responsive */
        .modal-xl-custom {
            max-width: 95%;
            margin: 0.5rem auto;
        }

        .modal-body {
            padding: 1rem;
        }

        /* Form responsive */
        .form-row {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 1rem;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 5px rgba(13, 110, 253, 0.4);
            border-color: #0d6efd;
        }

        /* Map responsive */
        .map-container {
            width: 100%;
            height: 200px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        /* Button styles */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            padding: 8px 18px;
            font-weight: 600;
            border-radius: 8px;
        }

        .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-primary {
            background-color: #0066cc;
            border-color: #0066cc;
        }

        .modal-header {
            background-color: #0066cc;
            color: white;
        }

        .modal-header .btn-close {
            filter: invert(1);
        }

        /* Responsive breakpoints */
        @@media (min-width: 576px) {
            .page-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .page-header .btn {
                width: auto;
                padding: 8px 18px;
            }

            .search-container {
                width: 50%;
            }

            .tile-icon {
                width: 60px;
                height: 60px;
                font-size: 26px;
                margin-right: 15px;
            }

            .tile-title {
                font-size: 15px;
            }

            .tile-number {
                font-size: 26px;
            }

            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .map-container {
                height: 250px;
            }
        }

        @@media (min-width: 768px) {
            .search-container {
                width: 40%;
            }

            .form-row {
                grid-template-columns: repeat(3, 1fr);
            }

            .form-row .col-span-2 {
                grid-column: span 2;
            }

            .form-row .col-span-3 {
                grid-column: span 3;
            }

            .modal-xl-custom {
                max-width: 900px;
            }
        }

        @@media (min-width: 992px) {
            .search-container {
                width: 30%;
            }

            .tile-box {
                padding: 20px;
            }

            .table-container {
                padding: 1.5rem;
            }
        }

        @@media (min-width: 1200px) {
            .container {
                padding: 0 20px;
            }
        }

        /* Mobile-specific styles */
        @@media (max-width: 575px) {
            .container {
                padding: 0 10px;
            }

            .page-header h4 {
                font-size: 1.25rem;
            }

            .tile-box {
                padding: 12px;
            }

            .tile-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
                margin-right: 10px;
            }

            .tile-number {
                font-size: 20px;
            }

            .table th, .table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.875rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.125rem;
            }

            .action-buttons .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            .modal-xl-custom {
                max-width: 98%;
                margin: 0.25rem auto;
            }

            .modal-body {
                padding: 0.75rem;
            }

            .form-control, .form-select {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* Print styles */
        @@media print {
            .btn, .modal, .search-container, .pagination-container {
                display: none !important;
            }

            .table-container {
                box-shadow: none;
                border: 1px solid #000;
            }

            .page-header {
                border-bottom: 2px solid #000;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
            }
        }
    </style>

    <div class="container-fluid mt-4">
        <div class="page-header">
            <h4>Sales Visit Management</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">+ Add Sales Visit</button>
        </div>

        <div class="search-container">
            <form id="searchForm" class="search-form">
                <input type="text" id="searchBox" class="form-control" placeholder="Search Visit..">
                <button type="submit" class="btn btn-success">Search</button>
            </form>
        </div>

        <!-- Stat Tiles -->
        <div class="stats-row">
            <div class="row g-3">
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="tile-box shadow-sm">
                        <div class="tile-icon bg-primary"><i class="fas fa-chart-line"></i></div>
                        <div class="tile-content">
                            <div class="tile-title">Total Visits</div>
                            <div class="tile-number">@Model.SalesVisits.Count()</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="tile-box shadow-sm">
                        <div class="tile-icon bg-success"><i class="fas fa-calendar-week"></i></div>
                        <div class="tile-content">
                            <div class="tile-title">This Week</div>
                            <div class="tile-number">@Model.SalesVisits.Count(x => x.VisitDate >= DateTime.Today.AddDays(-7))</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-4">
                    <div class="tile-box shadow-sm">
                        <div class="tile-icon bg-warning"><i class="fas fa-calendar-alt"></i></div>
                        <div class="tile-content">
                            <div class="tile-title">This Month</div>
                            <div class="tile-number">@Model.SalesVisits.Count(x => x.VisitDate >= DateTime.Today.AddDays(-30))</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Visit Code</th>
                            <th>Sales Person</th>
                            <th>Visit Date & Time</th>
                            <th>Meeting Type</th>
                            <th>Discussion Type</th>
                            <th>Agent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="visitTableBody">
                        <!-- Table content will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container" id="pagination"></div>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <form id="addVisitForm">
                    @Html.AntiForgeryToken()
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Add New Sales Visit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <input type="hidden" name="CreatedBy" id="createdByField" />
                    <input type="hidden" name="EntryLatitude" id="entryLat" />
                    <input type="hidden" name="EntryLongitude" id="entryLng" />

                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group d-none">
                                <label class="form-label">User</label>
                                <input type="text" class="form-control" readonly value="@loggedInUserName" />
                                <input type="hidden" name="UserId" id="userDropdown" value="@loggedInUserId" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Visit Date</label>
                                <input name="VisitDate" type="date" class="form-control" id="visitDate" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Visit Time</label>
                                <input name="VisitTime" id="visitTime" type="time" class="form-control" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Agent</label>
                                <select name="AgentId" id="agentDropdown" class="form-select" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Discussion Type</label>
                                <select name="DiscussionTypeId" id="discussionDropdown" class="form-select" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Meeting Type</label>
                                <select name="MeetingTypeId" id="meetingDropdown" class="form-select" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Venue Name</label>
                                <input name="MeetingVenueName" class="form-control" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Latitude</label>
                                <input name="MeetingLatitude" type="number" step="0.000001" class="form-control" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Longitude</label>
                                <input name="MeetingLongitude" type="number" step="0.000001" class="form-control" required />
                            </div>

                            <div class="form-group col-span-3">
                                <label class="form-label">Pick Location on Map</label>
                                <div id="map" class="map-container"></div>
                            </div>

                            <div class="form-group col-span-3">
                                <label class="form-label">Meeting Notes</label>
                                <textarea name="MeetingNotes" class="form-control" rows="3" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sales Visit Code</label>
                                <input name="SalesVisitCode" class="form-control" required />
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl-custom">
            <div class="modal-content">
                <form id="editVisitForm" method="post" action="@Url.Action("Edit","SalesVisit")">
                    @Html.AntiForgeryToken()
                    <input name="SalesVisitId" type="hidden" id="editSalesVisitId" />

                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Edit Sales Visit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="d-flex justify-content-between align-items-center border-bottom px-3 py-2 bg-white">
                        <div class="d-flex align-items-center flex-wrap">
                            <h6 class="me-2 text-muted fw-bold mb-0">Sales Visit Code:</h6>
                            <h6 id="displayEditCode" class="text-primary fw-bold mb-0">N/A</h6>
                        </div>
                    </div>

                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group d-none">
                                <label class="form-label">User</label>
                                <input type="text" class="form-control" readonly id="editUserName" />
                                <input type="hidden" name="UserId" id="editUserDropdown" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Visit Date</label>
                                <input name="VisitDate" type="date" class="form-control" id="editVisitDate" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Visit Time</label>
                                <input name="VisitTime" type="time" class="form-control" id="editVisitTime" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Agent</label>
                                <select name="AgentId" id="editAgentDropdown" class="form-select" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Meeting Type</label>
                                <select name="MeetingTypeId" class="form-select" id="editMeetingTypeDropdown" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Discussion Type</label>
                                <select name="DiscussionTypeId" class="form-select" id="editDiscussionTypeDropdown" required></select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Venue Name</label>
                                <input name="MeetingVenueName" class="form-control" id="editVenue" required />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Latitude</label>
                                <input name="MeetingLatitude" type="number" step="0.000001" class="form-control" required id="editLatitude" />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Longitude</label>
                                <input name="MeetingLongitude" type="number" step="0.000001" class="form-control" required id="editLongitude" />
                            </div>

                            <div class="form-group col-span-3">
                                <label class="form-label">Pick Location on Map</label>
                                <div id="editMap" class="map-container"></div>
                            </div>

                            <div class="form-group col-span-3">
                                <label class="form-label">Meeting Notes</label>
                                <textarea name="MeetingNotes" class="form-control" id="editNotes" rows="3" required></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Sales Visit Code</label>
                                <input name="SalesVisitCode" class="form-control" id="editCode" />
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" id="updateVisitBtn" class="btn btn-success">Update</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this sales visit?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfOLIUYqYgg76KY-NlqaXPPFb-5RlkSFc&callback=initMap" async defer></script>


    <script>

        const loggedInUserId = '@loggedInUserId';
        const userOperations = '@userOperations';

    </script>
    <script>

        $('#addModal').on('shown.bs.modal', function () {

            const today = new Date().toISOString().split('T')[0];
            $('#visitDate').attr('max', today);
            $('#visitDate').val('');

         

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        $('#entryLat').val(pos.coords.latitude.toFixed(6));
                        $('#entryLng').val(pos.coords.longitude.toFixed(6));

                        // Update marker position with current location
                        if (typeof google !== 'undefined' && map && marker) {
                            const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                            marker.setPosition(latLng);
                            map.setCenter(latLng);

                            // Trigger resize after slight delay
                            setTimeout(() => {
                                google.maps.event.trigger(map, 'resize');
                                map.setCenter(latLng);
                            }, 300);
                        }
                    },
                    () => {
                        fallbackMapCenter();
                    }
                );
            } else {
                fallbackMapCenter();
            }

            // Fallback center if location blocked or fails
            function fallbackMapCenter() {
                const lat = parseFloat($('#entryLat').val()) || 19.0760;
                const lng = parseFloat($('#entryLng').val()) || 72.8777;

                if (typeof google !== 'undefined' && map && marker) {
                    marker.setPosition({ lat, lng });
                    map.setCenter({ lat, lng });

                    setTimeout(() => {
                        google.maps.event.trigger(map, 'resize');
                        map.setCenter({ lat, lng });
                    }, 300);
                }
            }
        });


        function editVisit(id, btn) {
            const editButton = btn;
            const originalText = editButton.innerHTML;
            editButton.innerHTML = 'Loading...';
            editButton.disabled = true;

            fetch(`https://localhost:7228/api/SalesVisit/${id}`)
                .then(response => response.json())
                .then(data => {
                    Promise.all([
                        loadMeetingTypes(data.meetingTypeId),
                        loadDiscussionTypes(data.discussionTypeId),
                        loadAgents(data.agentId)
                    ]).then(() => {

                        $('#editSalesVisitId').val(data.salesVisitId);
                        // ✅ Set Visit Date without timezone issue
                        if (data.visitDate) {
                            const dateOnly = data.visitDate.includes('T') ? data.visitDate.split('T')[0] : data.visitDate;
                            $('#editVisitDate').val(dateOnly);

                            // Optional: Prevent selecting date after created date
                            $('#editVisitDate').attr('max', dateOnly);
                        }
                        $('#editVisitTime').val(data.visitTime || '');
                        $('#editVisitTime').attr('data-max', data.visitTime || '');

                        $('#editVenue').val(data.meetingVenueName || '');
                        $('#editLatitude').val(data.meetingLatitude ?? '');
                        $('#editLongitude').val(data.meetingLongitude ?? '');
                        $('#editNotes').val(data.meetingNotes || '');
                        $('#editCode').val(data.salesVisitCode || '');

                       $('#displayEditCode').text(data.salesVisitCode || '');


                        $('#editLatitude').val(data.meetingLatitude ?? '');
                        $('#editLongitude').val(data.meetingLongitude ?? '');

                        $('#editUserName').val('@loggedInUserName');
                        $('#editUserDropdown').val('@loggedInUserId');


                        if (data.visitDate) {
                            let dateOnly = data.visitDate;

                            // Handle date string with or without time
                            if (dateOnly.includes('T')) {
                                dateOnly = dateOnly.split('T')[0];
                            }

                            $('#editVisitDate').val(dateOnly);       // Set date field
                            $('#editVisitDate').attr('max', dateOnly);  // Prevent selecting future dates

                            console.log('Correct visit date:', dateOnly);  // For debugging
                        }


                        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                        editModal.show();

                        setTimeout(() => {
                            const lat = data.meetingLatitude || 19.0760;
                            const lng = data.meetingLongitude || 72.8777;
                            initEditMap(lat, lng);

                            google.maps.event.trigger(editMap, 'resize');
                        }, 500);


                    });
                })
                .catch(err => {
                    console.error(err);
                    alert('Error loading visit');
                })
                .finally(() => {
                    editButton.innerHTML = originalText;
                    editButton.disabled = false;
                });
        }


        // Handle form submission with better error handling
        document.getElementById('editVisitForm').addEventListener('submit', function (e) {
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.innerHTML = 'Updating...';
            submitButton.disabled = true;
        });

        // Reset button state when modal is hidden
        $('#editModal').on('hidden.bs.modal', function () {
            const submitButton = document.querySelector('#editVisitForm button[type="submit"]');
            submitButton.innerHTML = 'Update';
            submitButton.disabled = false;
        });
        $('#updateVisitBtn').on('click', function () {
            const visit = {
                salesVisitId: $('#editSalesVisitId').val(),
                userId: $('#editUserDropdown').val(), // Now this will have logged-in user's ID
                visitDate: $('#editVisitDate').val(),
                visitTime: $('#editVisitTime').val(),
                meetingTypeId: $('#editMeetingTypeDropdown').val(),
                discussionTypeId: $('#editDiscussionTypeDropdown').val(),
                meetingVenueName: $('#editVenue').val(),
                meetingLatitude: $('#editLatitude').val(),
                meetingLongitude: $('#editLongitude').val(),
                meetingNotes: $('#editNotes').val(),
                salesVisitCode: $('#editCode').val(),
                agentId: $('#editAgentDropdown').val(),
                UpdatedBy: parseInt(loggedInUserId)
            };

            $(this).prop('disabled', true).text('Updating...');

            $.ajax({
                url: `https://localhost:7228/api/SalesVisit/${visit.salesVisitId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(visit),
                success: function () {
                    location.reload();
                },
                error: function (xhr) {
                    alert('Error updating record: ' + xhr.responseText);
                },
                complete: function () {
                    $('#updateVisitBtn').prop('disabled', false).text('Update');
                }
            });
        });


        // Additional validation on date input change
        $('#visitDate').on('change', function () {
            $('#visitTime').val('');
            const selectedDateStr = $(this).val();
            const todayStr = new Date().toISOString().split('T')[0];

            if (selectedDateStr > todayStr) {
                alert('Visit date cannot be in the future');
                $(this).val('');
            }
        });

        $('#editVisitDate').on('change', function () {
            const selectedDateStr = $(this).val();
            const maxDateStr = $(this).attr('max');

            if (selectedDateStr > maxDateStr) {
                alert('Visit date cannot be after the original visit date (' + maxDateStr + ')');
                $(this).val('');
            }
        });

        // Reset date fields when modals are closed
        $('#addModal').on('hidden.bs.modal', function () {
            $('#visitDate').val('');
            $('#visitDate').removeAttr('max');
        });

        $('#editModal').on('hidden.bs.modal', function () {
            $('#editVisitDate').val('');
            $('#editVisitDate').removeAttr('max');
        });

        $('[name="VisitTime"]').on('change', function () {
            const selectedTime = $(this).val();
            const selectedDate = $('#visitDate').val();

            if (!selectedDate || !selectedTime) return;

            const today = new Date();
            const todayDateStr = today.toISOString().split('T')[0];

            if (selectedDate === todayDateStr) {
                const currentTime = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

                if (selectedTime > currentTime) {
                    alert('Visit time cannot be after current time.');
                    $(this).val('');
                }
            }
        });


        $('#editVisitTime').on('change', function () {
            const selectedTime = $(this).val();
            const maxTime = $(this).attr('data-max');  // Store created time in data attribute

            if (selectedTime > maxTime) {
                alert('Visit time cannot be after the original visit time (' + maxTime + ')');
                $(this).val('');
            }
        });


    </script>

    <script>
       

        function loadMeetingTypes(selectedId = "") {
            return $.get(`${apiBase}/MeetingType`, function (types) {
                $('#editMeetingTypeDropdown').empty().append(`<option value="">Select</option>`);
                $.each(types, function (i, type) {
                    $('#editMeetingTypeDropdown').append(`<option value="${type.meetingTypeId}">${type.meetingTypeName}</option>`);
                });
                $('#editMeetingTypeDropdown').val(selectedId);
            });
        }

        function loadDiscussionTypes(selectedId = "") {
            return $.get(`${apiBase}/DiscussionType`, function (types) {
                $('#editDiscussionTypeDropdown').empty().append(`<option value="">Select</option>`);
                $.each(types, function (i, type) {
                    $('#editDiscussionTypeDropdown').append(`<option value="${type.discussionTypeId}">${type.discussionTypeName}</option>`);
                });
                $('#editDiscussionTypeDropdown').val(selectedId);
            });
        }

        function loadAgents(selectedId = "") {
            return $.get(`${apiBase}/Agent`, function (agents) {
                $('#editAgentDropdown').empty().append(`<option value="">Select</option>`);
                $.each(agents, function (i, agent) {
                    $('#editAgentDropdown').append(`<option value="${agent.agentId}">${agent.agentName}</option>`);
                });
                $('#editAgentDropdown').val(selectedId);
            });
        }


    </script>
    <script>
        const apiBase = "https://localhost:7228/api";

        $('#addVisitForm').on('submit', function (e) {
            e.preventDefault();
            const visit = {
                UserId: parseInt($('#userDropdown').val()),
                VisitDate: $('[name="VisitDate"]').val(),
                VisitTime: $('[name="VisitTime"]').val(),
                AgentId: parseInt($('[name="AgentId"]').val()),
                MeetingTypeId: parseInt($('#meetingDropdown').val()),
                DiscussionTypeId: parseInt($('#discussionDropdown').val()),
                MeetingVenueName: $('[name="MeetingVenueName"]').val(),
                MeetingLatitude: parseFloat($('[name="MeetingLatitude"]').val()),
                MeetingLongitude: parseFloat($('[name="MeetingLongitude"]').val()),
                EntryLatitude: parseFloat($('#entryLat').val()),    // Add this
                EntryLongitude: parseFloat($('#entryLng').val()),
                MeetingNotes: $('[name="MeetingNotes"]').val(),
                SalesVisitCode: $('[name="SalesVisitCode"]').val(),
                CreatedBy: parseInt(loggedInUserId)  
            };



            console.log("Data sending to API:", visit);  

            $.ajax({
                url: `${apiBase}/SalesVisit`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(visit),
                success: function () {
                    location.reload();
                },
                error: function (xhr) {
                    console.error("Server Response:", xhr.responseText);
                    alert(`Error saving Sales Visit:\n${xhr.status} - ${xhr.responseText}`);
                }
            });
        });

    </script>
 
    <script>
        function loadDropdowns() {


            return new Promise((resolve, reject) => {
                let completed = 0;

                function checkComplete() {
                    completed++;
                    if (completed === 4) resolve();
                }

                $.get(`${apiBase}/User`, function (users) {
                    $('#editUserDropdown').empty();
                    $.each(users, function (i, user) {
                        $('#editUserDropdown').append(`<option value="${user.userId}">${user.firstName} ${user.lastName}</option>`);
                    });
                    checkComplete();
                }).fail(reject);

                $.get(`${apiBase}/MeetingType`, function (types) {
                    $('#meetingDropdown, #editMeetingTypeDropdown').empty().append(`<option value="">Select</option>`);
                    $.each(types, function (i, type) {
                        $('#meetingDropdown, #editMeetingTypeDropdown').append(`<option value="${type.meetingTypeId}">${type.meetingTypeName}</option>`);
                    });
                    checkComplete();
                }).fail(reject);

                $.get(`${apiBase}/DiscussionType`, function (types) {
                    $('#discussionDropdown, #editDiscussionTypeDropdown').empty().append(`<option value="">Select</option>`);
                    $.each(types, function (i, type) {
                        $('#discussionDropdown, #editDiscussionTypeDropdown').append(`<option value="${type.discussionTypeId}">${type.discussionTypeName}</option>`);
                    });
                    checkComplete();
                }).fail(reject);

                $.get(`${apiBase}/Agent`, function (agents) {
                    $('#agentDropdown, #editAgentDropdown').empty().append(`<option value="">Select</option>`);
                    $.each(agents, function (i, agent) {
                        $('#agentDropdown, #editAgentDropdown').append(`<option value="${agent.agentId}">${agent.agentName}</option>`);
                    });
                    checkComplete();
                }).fail(reject);
            });
        }


        $('#editModal').on('shown.bs.modal', function () {
          if (editMap) {
             google.maps.event.trigger(editMap, 'resize');
          }
      });


     

        $('#updateVisitBtn').on('click', function () {
            debugger;
            const visit = {
                salesVisitId: $('#editSalesVisitId').val(),
                userId: parseInt($('#editUserDropdown').val()),

                visitDate: $('#editVisitDate').val(),
                visitTime: $('#editVisitTime').val(),
                meetingTypeId: $('#editMeetingTypeDropdown').val(),
                discussionTypeId: $('#editDiscussionTypeDropdown').val(),
                meetingVenueName: $('#editVenue').val(),
                meetingLatitude: $('#editLatitude').val(),
                meetingLongitude: $('#editLongitude').val(),
                meetingNotes: $('#editNotes').val(),
                salesVisitCode: $('#editCode').val(),
                agentId: $('#editAgentDropdown').val(),
                UpdatedBy: parseInt(loggedInUserId)
            };

            $(this).prop('disabled', true).text('Updating...');

            $.ajax({
                url: `https://localhost:7228/api/SalesVisit/${visit.salesVisitId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(visit),
                success: function () {
                    location.reload();
                },
                error: function () {
                    alert('Server error. Try again.');
                },
                complete: function () {
                    $('#updateVisitBtn').prop('disabled', false).text('Update');
                }
            });
        });


        let deleteId = 0; // To store which record to delete

        function deleteVisit(id) {
            deleteId = id;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            deleteModal.show();
        }

        $('#confirmDeleteBtn').click(function () {
            if (deleteId === 0) return;

            $.ajax({
                url: `${apiBase}/SalesVisit/${deleteId}`,
                type: 'DELETE',
                success: function () {
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    deleteModal.hide(); // Close the modal

                    loadVisits(); // Reload grid after deletion
                },
                error: function () {
                    alert('Error deleting record');
                }
            });

            deleteId = 0; // Reset
        });

    </script>


    <script>

        function loadVisits(page = 1, search = "") {
            const canSeeAll = userOperations.includes('CanSeeOtherUsersRecords');
            const userId = loggedInUserId;
            const url = `${apiBase}/SalesVisit/Paged?page=${page}&pageSize=10&search=${encodeURIComponent(search)}${canSeeAll ? "" : `&userId=${userId}`}`;

            $.get(url, function (res) {
                let html = "";
                res.items.forEach(v => {
                    const dateOnly = v.visitDate?.split('T')[0] || '';
                    html += `<tr>
                                <td>${v.salesVisitCode}</td>
                        <td>${v.userName}</td>
                           <td>${dateOnly} ${v.visitTime}</td>
                    
                        <td>${v.meetingTypeName}</td>
                        <td>${v.discussionTypeName}</td>
                        <td>${v.agentName}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editVisit(${v.salesVisitId}, this)">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteVisit(${v.salesVisitId})">Delete</button>
                               

                        </td>
                    </tr>`;
                });
                $('#visitTableBody').html(html);

                // Pagination
                let pagHtml = "";
                const totalPages = Math.ceil(res.totalCount / 10);
                for (let i = 1; i <= totalPages; i++) {
                    pagHtml += `<button class="btn btn-sm ${i == page ? 'btn-primary' : 'btn-outline-primary'} me-1" onclick="loadVisits(${i}, '${search}')">${i}</button>`;
                }
                $('#pagination').html(pagHtml);
            });
        }

        $(document).ready(function () {
            loadDropdowns();
            loadVisits();

            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                const search = $('#searchBox').val();
                loadVisits(1, search);
            });
        });


        </script>

    <script>
        let map;
        let marker;
        window.initMap = function () {
            const defaultCoords = { lat: 19.0760, lng: 72.8777 }; // Mumbai as default

            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultCoords,
                zoom: 15,
            });

            marker = new google.maps.Marker({
                position: defaultCoords,
                map: map,
                draggable: false
            });

            if (navigator.geolocation) {
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const userCoords = {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude
                        };


                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;

                        $('#entryLat').val(lat.toFixed(6));
                        $('#entryLng').val(lng.toFixed(6));

                        map.setCenter(userCoords);
                        marker.setPosition(userCoords);
                        $('[name="MeetingLatitude"]').val(userCoords.lat.toFixed(6));
                        $('[name="MeetingLongitude"]').val(userCoords.lng.toFixed(6));
                    },
                    (error) => {
                        console.warn("Geolocation permission denied or unavailable", error);
                        $('[name="MeetingLatitude"]').val(defaultCoords.lat);
                        $('[name="MeetingLongitude"]').val(defaultCoords.lng);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
                $('[name="MeetingLatitude"]').val(defaultCoords.lat);
                $('[name="MeetingLongitude"]').val(defaultCoords.lng);
            }

            // Map click to update location manually
            map.addListener("click", (e) => {
                const clickedCoords = {
                    lat: e.latLng.lat(),
                    lng: e.latLng.lng()
                };
                marker.setPosition(clickedCoords);
                $('[name="MeetingLatitude"]').val(clickedCoords.lat.toFixed(6));
                $('[name="MeetingLongitude"]').val(clickedCoords.lng.toFixed(6));
            });

            // Manual input changes marker position
            $('[name="MeetingLatitude"], [name="MeetingLongitude"]').on('input', function () {
                const lat = parseFloat($('[name="MeetingLatitude"]').val());
                const lng = parseFloat($('[name="MeetingLongitude"]').val());
                if (!isNaN(lat) && !isNaN(lng)) {
                    const newCoords = { lat: lat, lng: lng };
                    map.setCenter(newCoords);
                    marker.setPosition(newCoords);
                }
            });
        };





    </script>
    <script>
        let editMap;
    let editMarker;

function initEditMap(lat = 19.0760, lng = 72.8777) {
    const coords = { lat: parseFloat(lat), lng: parseFloat(lng) };

    editMap = new google.maps.Map(document.getElementById("editMap"), {
        center: coords,
        zoom: 15,
    });

    editMarker = new google.maps.Marker({
        position: coords,
        map: editMap,
        draggable: false
    });

    editMap.addListener("click", (e) => {
        const clickedCoords = {
            lat: e.latLng.lat(),
            lng: e.latLng.lng()
        };
        editMarker.setPosition(clickedCoords);
        $('#editLatitude').val(clickedCoords.lat.toFixed(6));
        $('#editLongitude').val(clickedCoords.lng.toFixed(6));
    });
}

    </script>
